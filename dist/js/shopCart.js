"use strict";var _init=require("./init.js");function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),t}$(function(){(0,_init.Init)(),$.get({url:"http://localhost/commodities/shopCart",success:function(t){0==t.status?($(".msg").show(),$(".wrap").hide()):new ShopCart(t.data,$(".wrap")).init()}})});var ShopCart=function(){function a(t,e){_classCallCheck(this,a),this.data=t,this.root=e}return _createClass(a,[{key:"init",value:function(){var a=this;Object.defineProperty(this,"num",{get:function(){return this.data.reduce(function(t,e){return e.isSelect?t+e.count:t},0)}}),Object.defineProperty(this,"allNum",{get:function(){return this.data.reduce(function(t,e){return t+e.count},0)}}),Object.defineProperty(this,"total",{get:function(){return(this.data.reduce(function(t,e){return e.isSelect?t+e.price*e.count:t},0)+0).toFixed(2)}});for(var t=function(t){var e=a.data[t];Object.defineProperty(e,"xiaoji",{get:function(){return(e.count*e.price+0).toFixed(2)}})},e=0;e<this.data.length;e++)t(e);this.renderUI(),this.addEventHandle()}},{key:"renderUI",value:function(){var t='\n    <p>我的购物车</p>\n    <div class="cart-header">\n      <div><input class="allSelect" type="checkbox"></div>\n      <span class="first">商品信息</span>\n      <span>赠送积分</span>\n      <span>销售价格</span>\n      <span>数量</span>\n      <span>折扣/优惠</span>\n      <span>小计</span>\n      <span>操作</span>\n    </div>\n    {{if $data.length==0}}\n      <p class="warning">购物车还是空的，还不快点去剁手！！！</p>\n\n    {{else if $data.length!=0}}\n    <ul class="cart-body">\n    {{each $data}}\n      <li>\n        <div class="checkbox"><input {{$value.isSelect==1?\'checked\':\'\'}} type="checkbox"></div>\n        <div class="first">\n          <a href="#" class="img">\n            <img width="50" height="50" src={{$value.bigSrc}} alt="">\n            <img class="big-img" src={{$value.bigSrc}} alt="">\n          </a>\n          <a href="#" class="desc">\n            <span class="name">\n            {{$value.name}}\n            </span>\n            <span class="info">\n              (尺码:{{$value.selectSize}},颜色:{{$value.color}} )\n            </span>\n          </a>\n        </div>\n        <div>0</div>\n        <div>￥<span>{{($value.price+0.00).toFixed(2)}}</span></div>\n        <div class="btns clearfix">\n          <a href="#" class="fl">-</a>\n          <input type="text" class="fl" value={{$value.count}}>\n          <a href="#" class="fl">+</a>\n        </div>\n        <div>-</div>\n        <div>￥<span class="xiaoji">{{$value.xiaoji}}</span></div>\n        <div><a href="#" class="del">删除</a></div>\n      </li>\n      {{/each}};\n    </ul>\n    <div class="cart-footer clearfix">\n        <p>已选商品数量：<span class="num">'.concat(this.num,'</span></p>\n        <p>商品总金额：<span class="total">￥').concat(this.total,'</span></p>\n\n        <a href="#" class="settlement">下单结算</a>\n    </div>\n    {{/if}}\n    ');this.root.html(template.render(t,this.data)),this.allSelect=$(".allSelect"),this.$num=$(".num"),this.$total=$(".total"),this.isAllSelect()&&this.allSelect.prop("checked",!0)}},{key:"addEventHandle",value:function(){var i=this;this.root.on("click","input[type=checkbox]",function(){var e=$(this).prop("checked")?1:0;if($(this).hasClass("allSelect"))$("input[type=checkbox]").prop("checked",e),i.data.forEach(function(t){t.isSelect=e,i.updateSQL(t.commodityId,t.count,t.selectSize,t.isSelect)});else{var t=$(this).parents("li").index();i.data[t].isSelect=e,i.allSelect.prop("checked",i.isAllSelect()),i.updateSQL(i.data[t].commodityId,i.data[t].count,i.data[t].selectSize,i.data[t].isSelect)}i.$num.text(i.num),i.$total.text("￥"+i.total)}),this.root.on("click",".btns a",function(t){t.preventDefault();var e=$(this).parents("li"),a=e.index();if("-"==$(this).text()){if(i.data[a].count<=1)return;$(this).next().val(--i.data[a].count)}else{if(20<=i.data[a].count)return;$(this).prev().val(++i.data[a].count)}e.find(".xiaoji").text((i.data[a].count*i.data[a].price+0).toFixed(2)),i.updateSQL(i.data[a].commodityId,i.data[a].count,i.data[a].selectSize,i.data[a].isSelect),i.$num.text(i.num),$(".cart-num").text(i.allNum),i.$total.text("￥"+i.total)}),this.root[0].oninput=function(t){t=t||window.event;var e=$(t.target);if("checkbox"!=e.attr("type")){var a=e.parents("li"),n=a.index();/\d/.test(t.data)||null==t.data||e.val(i.data[n].count),1*e.val()<1?e.val(1):20<1*e.val()&&e.val(20),i.data[n].count=1*e.val(),a.find(".xiaoji").text((i.data[n].count*i.data[n].price+0).toFixed(2)),i.updateSQL(i.data[n].commodityId,i.data[n].count,i.data[n].selectSize,i.data[n].isSelect),i.$num.text(i.num),$(".cart-num").text(i.allNum),i.$total.text("￥"+i.total)}},this.root.find(".del").click(function(t){if(t.preventDefault(),confirm("是否要删除？")){var e=$(this).parents("li"),a=e.index(),n=i.data.splice(a,1)[0];e.remove(),i.deleteSQL(n.commodityId,n.selectSize),i.$num.text(i.num),$(".cart-num").text(i.allNum),i.$total.text("￥"+i.total)}}),this.root.find(".settlement").click(function(t){t.preventDefault(),0!=i.data.filter(function(t){return 1==t.isSelect}).length?i.settleMent():alert("未选择购买商品，请选择")})}},{key:"isAllSelect",value:function(){return this.data.every(function(t){return 1==t.isSelect})}},{key:"updateSQL",value:function(t,e,a,n){$.ajax({type:"put",url:"http://localhost/commodities/shopCart",data:{commodityId:t,count:e,selectSize:a,isSelect:n},success:function(t){1!=t.status&&(alert(t.msg),location.reload())}})}},{key:"deleteSQL",value:function(t,e){$.ajax({type:"delete",url:"http://localhost/commodities/shopCart",data:{commodityId:t,selectSize:e},success:function(t){1!=t.status&&(alert(t.msg),location.reload())}})}},{key:"settleMent",value:function(){var e=this;$.ajax({type:"delete",url:"http://localhost/commodities/settlement",success:function(t){1==t.status?alert("恭喜你剁手成功,一共花费"+e.total):alert(t.msg),location.reload()}})}}]),a}();